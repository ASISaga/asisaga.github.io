{% comment %}
  Product Service - Middle tier data processor for product data
  
  This component acts as a service layer between raw product data in _data directory
  and the presentation templates. It provides standardized access methods and computed properties.
  
  Parameters:
    product_id: The product identifier (e.g., "github_agent", "agent_operating_system")
    
  Returns:
    A processed product object with additional computed properties.
    Access using the variable name specified in the 'assign_to' parameter.
    
  Example usage:
    {% include data-services/product-service.html 
       product_id="github_agent" 
       assign_to="processed_product" %}
    
    {{ processed_product.title }}
{% endcomment %}

{% if include.product_id %}
  {% assign raw_product = site.data[include.product_id] %}
{% else %}
  {% assign product_path = page.path | split: "/" %}
  {% if product_path.size >= 3 %}
    {% assign inferred_product_id = product_path[1] | replace: '-', '_' %}
    {% assign raw_product = site.data[inferred_product_id] %}
  {% endif %}
{% endif %}

{% if raw_product %}
  {% assign processed_product = raw_product %}
  
  {% comment %} Add computed fields {% endcomment %}
  {% assign has_features = false %}
  {% if raw_product.features.items.size > 0 %}
    {% assign has_features = true %}
  {% endif %}
  
  {% assign has_benefits = false %}
  {% if raw_product.benefits.items.size > 0 %}
    {% assign has_benefits = true %}
  {% endif %}
  
  {% assign has_concepts = false %}
  {% if raw_product.concepts %}
    {% assign has_concepts = true %}
  {% endif %}
  
  {% assign has_implementation = false %}
  {% if raw_product.implementation %}
    {% assign has_implementation = true %}
  {% endif %}
  
  {% assign has_applications = false %}
  {% if raw_product.applications.items.size > 0 %}
    {% assign has_applications = true %}
  {% endif %}
  
  {% comment %} Store computed fields in a hash {% endcomment %}
  {% capture computed_fields %}
    {
      "has_features": {{ has_features }},
      "has_benefits": {{ has_benefits }},
      "has_concepts": {{ has_concepts }},
      "has_implementation": {{ has_implementation }},
      "has_applications": {{ has_applications }},
      "product_id": "{{ include.product_id | default: inferred_product_id }}",
      "product_url": "/realm-of-agents/{{ include.product_id | default: inferred_product_id | replace: '_', '-' }}/"
    }
  {% endcapture %}
  
  {% comment %} Merge raw product with computed fields (not actually possible in pure Liquid) {% endcomment %}
  {% if include.assign_to %}
    {% assign processed_product_with_computed = processed_product %}
    {% assign processed_product_with_computed.computed = computed_fields %}
  {% endif %}
{% endif %}

{% comment %} Assign the processed product to the variable name specified {% endcomment %}
{% if include.assign_to %}
  {% assign temp = processed_product_with_computed %}
  {% assign temp.computed_has_features = has_features %}
  {% assign temp.computed_has_benefits = has_benefits %}
  {% assign temp.computed_has_concepts = has_concepts %}
  {% assign temp.computed_has_implementation = has_implementation %}
  {% assign temp.computed_has_applications = has_applications %}
  {% assign temp.computed_product_id = include.product_id | default: inferred_product_id %}
  {% assign temp.computed_product_url = "/realm-of-agents/" | append: include.product_id | default: inferred_product_id | replace: "_", "-" | append: "/" %}
  {% assign variable_name = include.assign_to %}
  {% assign outer_scope = variable_name | append: " = temp" %}
  {% capture _ %}{{ outer_scope }}{% endcapture %}
{% endif %}
